@using ShopApplication.Common
@using ShopWeb.Utilities
@using RetailDomain.Optionals
@inherits PageComponent

<PageTitle>Confirm Email</PageTitle>

@if (confirmFailed) {
    <h1>Email Confirmation Failed!</h1>
    <h2>Error Details: @apiReply.Message()</h2>
    <p>Please click <button class="btn btn-link" onclick="@(async () => await GoToResend())">here</button> to try sending another confirmation link, or contact support.</p>
}
else if (emailConfirmed) {
    <h1>Email Confirmed!</h1>
    <p>Your account has been verified and you can now <button class="btn btn-link" onclick="@(async () => await GoToLogin())">login normally.</button></p>
}

@code 
{
    [SupplyParameterFromQuery] string? Email { get; set; }
    [SupplyParameterFromQuery] string? Code { get; set; }
    
    bool emailConfirmed = false;
    bool confirmFailed = false;
    Opt<bool> apiReply;
    
    protected override async Task OnInitializedAsync()
    {
        await CallStartLoading( "Confirming email..." );

        if (!ValidateLink( out string userId, out string code, out string errorMessage )) {
            await CallPushAlert( AlertType.Danger, errorMessage );
            return;
        }
        
        apiReply = await TryConfirmEmail( Urls.ApiConfirmEmail, userId, code );
        emailConfirmed = apiReply.IsOkay();
        confirmFailed = !emailConfirmed;
        
        StateHasChanged();
        await CallStopLoading();
    }

    async Task GoToResend() => await CallNavigateTo( Urls.PageResendConfirm, false );
    async Task GoToLogin() => await CallNavigateTo( Urls.PageLoginOrRegister, false );
    async Task<Opt<bool>> TryConfirmEmail( string url, string userId, string code ) => await Http.TryPutRequest<bool>( url, new ConfirmEmailRequest( userId, code ) );
    
    bool ValidateLink( out string userId, out string code, out string errorMessage )
    {
        userId = string.Empty;
        code = string.Empty;
        errorMessage = string.Empty;
        
        if (string.IsNullOrEmpty( Email )) {
            errorMessage = $"Failed to confirm email address. {nameof( Email )} is invalid.";
            return false;
        }

        if (string.IsNullOrEmpty( Code )) {
            errorMessage = $"Failed to confirm email address. {nameof( Code )} is invalid.";
            return false;
        }

        userId = Email;
        code = Code;

        return true;
    }
    
    readonly record struct ConfirmEmailRequest(
        string Email,
        string Token );
}