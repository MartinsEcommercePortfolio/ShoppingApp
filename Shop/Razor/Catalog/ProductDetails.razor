@page "/product"
@using Shop.Infrastructure.Catalog.Products.Models
@using Shop.Utilities
@using Shop.Infrastructure.Catalog.Products.Dtos
@using Shop.Infrastructure.Catalog.Categories
@using Shop.Infrastructure.Catalog.Brands
@using Shop.Infrastructure.Catalog.Categories.Types
@using System.Xml.Linq
@using Shop.Infrastructure.Catalog.Brands.Types
@using Shop.Infrastructure.Common.ReplyTypes
@inherits Shop.Razor.Shared.ShopPage
@inject CategoriesCache Categories;
@inject BrandsCache Brands;

@if (_productLoaded)
{
    <!-- CONTAINER -->
    <div class="product-container">
        <!-- TOP -->
        <div class="product-top">
            
            <!-- IMAGE -->
            <div class="product-top-image">
                <img src="@_product.Image" alt="@_product.Name"/>
            </div>
            
            <!-- MAIN -->
            <div class="product-top-main">
                
                <!-- TITLE -->
                <h3 class="product-title">
                    @_product.Name
                </h3>
                
                <!-- CONTENT -->
                <div class="product-top-main-content">
                    
                    <!-- SUMMARY -->
                    <div class="product-summary">

                        <!-- RATING & BRAND -->
                        <div class="product-rating-brand">
                            <!-- RATING -->
                            <div class="product-rating">
                                @for ( int i = 1; i <= 5; i++ )
                                {
                                    <div>
                                        <i class="fa fa-star fa-xs @GetRatingCss( _product, i )"></i>
                                    </div>
                                }
                                <small class="d-block ms-1 text-muted">(@_product.NumberRatings Ratings)</small>
                            </div>
                            <!-- BRAND -->
                            <div class="product-brand">
                                <span class="d-block text-muted">Brand:&nbsp;</span>
                                <button class="d-block btn btn-link" @onclick="@(() => OnClickBrand( _product.Brand ))">@_product.Brand.Name</button>
                            </div>
                        </div>
                    </div>

                    <!-- CATEGORIES -->
                    <div class="product-categories d-flex flex-row flex-wrap align-items-center justify-content-start gap-2 py-3">
                        @foreach ( Category c in _product.Categories )
                        {
                            <button class="d-inline-block btn btn-sm btn-outline-secondary mb-1" @onclick="() => OnClickCategory( c )">@c.Name</button>
                        }
                    </div>

                    <!-- PRICE & SHIPPING -->
                    <div class="product-pricing-shipping">
                        <!-- PRICING -->
                        <div class="product-pricing">
                            @if (_product.SalePrice > 0)
                            {
                                <div class="product-price me-2">$@_product.SalePrice</div>
                                <div class="text-muted text-decoration-line-through">$@_product.Price</div>
                            }
                            else
                            {
                                <span class="product-price">$@_product.Price</span>
                            }
                        </div>
                        <!-- SHIPPING -->
                        <div class="product-shipping">
                            <small class="@GetDeliveryEstimateColor( _product )">
                                @GetDeliveryEstimateText( _product )
                            </small>
                            <button class="btn btn-link btn-icon product-shipping-button" @onclick="OnClickAddress">
                                <div>
                                    <i class="fa fa-location-dot ms-1"></i>
                                    &nbsp;Deliver To:&nbsp;
                                </div>
                                <div>
                                    @GetDeliveryToText()
                                    <i class="fa ms-1 @GetDeliveryToIcon()"></i>
                                </div>
                            </button>
                        </div>
                    </div>
                    
                    @if (_showAddressBox)
                    {
                        <!-- ADDRESS FORM -->
                        <div class="product-address-form">
                            <div class="product-address-form-inputs mb-2">
                                <input type="number" min="0" max="100000" step="1" value="@PosX" @onchange="OnChangePosX" class="form-control"/>
                                <input type="number" min="0" max="100000" step="1" value="@PosY" @onchange="OnChangePosY" class="form-control"/>
                            </div>
                            <button class="btn btn-primary btn-icon search-filters-btn-main" @onclick="OnClickApplyLocation">
                                <i class="fa-solid fa-circle-check me-2"></i>
                                Save Address
                            </button>
                        </div>
                    }

                    <!-- CART -->
                    <div class="product-cart">
                        @if (IsProductInCart( _product, out int count ))
                        {
                            <!-- CART BUTTON -->
                            <a class="btn btn-primary btn-icon w-100">
                                <i class="fa fa-shopping-cart me-2"></i>
                                <small>View In Cart (@count)</small>
                            </a>
                        }
                        else if (!_product.IsInStock)
                        {
                            <!-- DISABLED BUTTON -->
                            <button disabled class="btn btn-secondary btn-icon w-100">
                                <i class="fa-solid fa-circle-xmark fa-xs"></i>
                                <small>Out of Stock</small>
                            </button>
                        }
                        else
                        {
                            <!-- ADD BUTTON -->
                            <button class="btn btn-primary btn-icon" @onclick="@(async () => await OnClickAddToCart())">
                                <i class="fa-solid fa-shopping-cart fa-xs"></i>
                                <small>Add To Cart</small>
                            </button>
                            <!-- DROPDOWN LIST -->
                            <div class="form-group w-50">
                                <select id="quantitySelect" class="btn btn-outline-secondary btn-icon form-select h-100 w-100" @onchange="OnQuantityChange" value="@_selectedQuantity">
                                    @foreach ( int quantity in Quantities )
                                    {
                                        <option value="@quantity" selected="@( _selectedQuantity == quantity )">Qty: @quantity</option>
                                    }
                                </select>
                            </div>
                        }
                    </div>
                </div>
            </div>
        </div>
        
        <!-- DESCRIPTION -->
        <div class="product-description">
            <h3>Description</h3>
            <p class="mb-0">@_product.Description</p>
        </div>
        
        <!-- XML -->
        <div class="product-xml">
            <h3>Specifications</h3>
            <div class="product-xml-wrapper">
                <table class="table table-bordered">
                    <tbody>
                    @foreach ( var kvp in _productSpecs )
                    {
                        <tr>
                            <th class="product-xml-th bg-light">@kvp.Key</th>
                            <td class="product-xml-td">@kvp.Value</td>
                        </tr>
                    }
                    </tbody>
                </table>
            </div>
        </div>
        
</div>
}

@code 
{
    [SupplyParameterFromQuery]
    public Guid ProductId { get; set; }
    [SupplyParameterFromQuery]
    public int? PosX { get; set; }
    [SupplyParameterFromQuery]
    public int? PosY { get; set; }

    readonly int[] Quantities = [1, 2, 3, 5, 10];
    int _selectedQuantity = 1;

    Product _product = default!;
    bool _productLoaded = false;
    bool _showAddressBox = false;
    Dictionary<string, string> _productSpecs = [];

    protected override async Task OnInitializedAsync()
    {
        await base.OnInitializedAsync();
        Dictionary<string, object> parameters = new() {
            { "ProductId", ProductId }
        };
        if (PosX is not null && PosY is not null)
        {
            parameters.Add( nameof( PosX ), PosX );
            parameters.Add( nameof( PosY ), PosY );
        }
        var reply = await Http.GetAsync<ProductDto>( Consts.ApiGetDetails, parameters );
        if (!reply)
        {
            PushError( reply, "Failed to get product details." );
            return;
        }

        var cats = Categories.GetCategories();
        var brands = Brands.GetBrands();

        await Task.WhenAll( cats, brands );

        if (!cats.Result.Succeeded || !brands.Result.Succeeded)
            return;

        _product = Product.From( reply.Data, cats.Result.Data, brands.Result.Data );
        _productSpecs = ParseXmlToDictionary( _product.Xml );
        _productLoaded = true;
        StateHasChanged();
    }
    
    async Task OnClickAddToCart()
    {
        await Task.Delay( 1000 );
        StateHasChanged();
    }
    async Task OnClickApplyLocation()
    {
        if (!PosX.HasValue || !PosY.HasValue)
        {
            PushWarning( "Invalid Location!" );
            return;
        }

        string apiUrl = $"{Consts.ApiGetEstimates}?ProductIds={_product.Id}&PosX={PosX}&PosY={PosY}";
        string pageUrl = $"{Consts.PageProductDetails}?ProductId={_product.Id}&PosX={PosX}&PosY={PosY}";
        
        Navigation.NavigateTo( pageUrl );
        Reply<List<int>> estimateReply = await Http.GetAsync<List<int>>( apiUrl );

        if (!estimateReply.Succeeded)
        {
            PushWarning( "Failed to get delivery estimate." );
            return;
        }

        _product.ShippingDays = estimateReply.Data.FirstOrDefault();
        StateHasChanged();
    }
    
    void OnClickCategory( Category c )
    {
        Navigation.NavigateTo( $"{Consts.PageProductSearch}?CategoryId={c.Id}", true );
    }
    void OnClickBrand( Brand b )
    {
        Navigation.NavigateTo( $"{Consts.PageProductSearch}?BrandIds={b.Id}", true );
    }
    void OnClickAddress()
    {
        _showAddressBox = !_showAddressBox;
        StateHasChanged();
    }
    void OnChangePosX( ChangeEventArgs args )
    {
        if (!int.TryParse( args.Value?.ToString(), out int result ))
            PosX = null;
        else
            PosX = result;
    }
    void OnChangePosY( ChangeEventArgs args )
    {
        if (!int.TryParse( args.Value?.ToString(), out int result ))
            PosY = null;
        else
            PosY = result;
    }

    void OnQuantityChange( ChangeEventArgs e )
    {
        _selectedQuantity = int.Parse( e.Value?.ToString() ?? string.Empty );
    }
    bool IsProductInCart( Product p, out int count )
    {
        // TODO: Implement
        count = 0;
        return false;
    }

    static Dictionary<string, string> ParseXmlToDictionary( string? xmlString )
    {
        if (string.IsNullOrWhiteSpace( xmlString ))
            return [];

        var xmlDictionary = new Dictionary<string, string>();
        XDocument xDoc = XDocument.Parse( xmlString );

        foreach ( var element in xDoc.Root?.Elements() ?? [] )
        {
            xmlDictionary[element.Name.LocalName] = element.Value;
        }

        return xmlDictionary;
    }
    static string GetRatingCss( Product item, int level ) =>
        item.Rating >= level ? "rating-star-full" : "rating-star-empty";
    string GetDeliveryToText() =>
        PosX is null || PosY is null ? "(0 , 0)" : $"({PosX} , {PosY})";
    string GetDeliveryToIcon() =>
        _showAddressBox ? "fa-angle-up" : "fa-angle-down";
    static string GetDeliveryEstimateText( Product item )
    {
        if (item.ShippingDays <= 0)
            return "Enter an address";
        
        return item.IsInStock 
            ? $"Get within {item.ShippingDays} days" 
            : "Out of stock";
    }
    static string GetDeliveryEstimateColor( Product item ) =>
        item.IsInStock ? "text-success" : "text-danger";
}